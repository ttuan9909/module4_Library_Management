<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Library - Borrow Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/ad-lending.css}">
</head>
<body>

<!-- Sidebar -->
<div th:replace="admin/fragment/sidebar :: sidebar"></div>

<!-- Main content -->
<div class="main-content">
    <div class="page-header mb-4 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Borrow Books</h5>
        <button class="btn btn-primary"> Save </button>
    </div>

    <!-- Content: 2 panels side by side -->
    <div class="content-area row g-4">
        <!-- Reader Panel -->
        <div class="col-md-4">
            <div class="reader-panel">
                <h6 class="mb-3">Reader Information</h6>

                <div class="input-group mb-3">
                    <input id="readerSelectInput" type="text" class="form-control" placeholder="Enter User ID, Phone Number or Email">
                    <button class="btn btn-primary" onclick="searchUser()">Select</button>
                </div>

                <div id="userInfo" class="mt-3">
                    <p id="errorMessage"></p>
                </div>
            </div>
        </div>

        <!-- Book Selection Panel -->
        <div class="col-md-8">
            <div class="book-panel">
                <h6 class="mb-3">Select Books to Borrow</h6>

                <!-- Select book -->
                <div class="input-group mb-2">
                    <input id="bookSelectInput" type="text" class="form-control" placeholder="Enter Book Code" onkeyup="showSuggestions(this.value)">
                    <button class="btn btn-primary" onclick="searchBook()">Select</button>
                </div>

<!--                &lt;!&ndash; Autocomplete suggestions &ndash;&gt;-->
<!--                <div id="bookSuggestions" class="suggestions d-none"></div>-->

<!--                &lt;!&ndash; Selected book result &ndash;&gt;-->
<!--                <div id="bookResult" class="alert alert-info d-none mt-3">-->
<!--                    <div class="d-flex justify-content-between align-items-center">-->
<!--                        <span id="bookTitle"></span>-->
<!--                        <button class="btn btn-sm btn-success" onclick="addBook()">Add</button>-->
<!--                    </div>-->
<!--                </div>-->

                <!-- Selected books -->
                <h6 class="mt-4">Selected Books</h6>
                <table class="table table-hover align-middle" id="selectedBooksTable">
                    <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Book Title</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Dynamic rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    let selectedBooks = [];

    function searchUser() {
        const q = $("#readerSelectInput").val().trim();
        if (!q) {
            $("#errorMessage").text("Please enter user ID, phone number or email.");
            $("#userInfo").empty();
            return;
        }

        const url = "/api/users/" + encodeURIComponent(q);
        $("#errorMessage").text("Searching...");
        $("#userInfo").empty();

        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                const rows = `
              <ul class="list-group">
                <li class="list-group-item"><strong>Full Name:</strong> <span id="uFullName">${data.fullName ?? ""}</span></li>
                <li class="list-group-item"><strong>Email:</strong> <span id="uEmail">${data.email ?? ""}</span></li>
                <li class="list-group-item"><strong>Phone:</strong> <span id="uPhone">${data.phoneNumber ?? ""}</span></li>
                <li class="list-group-item"><strong>Status:</strong> <span id="uStatus">${data.status ?? ""}</span></li>
              </ul>`;
                $("#userInfo").html(rows);
            },
            error: function (xhr, status, error) {
                let message = "Have an error.";
                try {
                    const json = JSON.parse(xhr.responseText);
                    if (json.message) message = json.message;
                } catch (e) {
                    message = xhr.responseText || "Can't connect to server.";
                }

                $("#errorMessage").text(message);
                $("#userInfo").empty();
                console.error("Ajax error:", status, error);
            }

        });
    }

    function searchBook() {
        const q = $("#bookSelectInput").val().trim();
        if (!q) {
            $("#errorMessage").text("Please enter book code.");
            $("#bookResult").empty();
            return;
        }

        const url = "/api/books/" + encodeURIComponent(q);
        $("#errorMessage").text("Searching...");
        $("#bookResult").empty();

        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                selectedBooks.push(data);
                console.log(selectedBooks);
            }
        })
    }
</script>
