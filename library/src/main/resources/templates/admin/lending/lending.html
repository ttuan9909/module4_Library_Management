<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Library - Borrow Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/ad-lending.css}">
</head>
<body>

<div th:replace="admin/fragment/sidebar :: sidebar"></div>

<div class="main-content">
    <div class="page-header mb-4 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Borrow Books</h5>
        <button class="btn btn-primary" onclick="borrowBook()"> Save </button>
    </div>

    <div class="content-area row g-4">
        <div class="col-md-4">
            <div class="reader-panel">
                <h6 class="mb-3">Reader Information</h6>

                <div class="input-group mb-3">
                    <input id="readerSelectInput" type="text" class="form-control" placeholder="Enter User ID, Phone Number or Email">
                    <button class="btn btn-primary" onclick="searchUser()">Select</button>
                </div>
                <small id="errorMessage" class="text-danger"></small>
                <div id="userInfo" class="mt-3"></div>
            </div>
        </div>

        <!-- Book Selection Panel -->
        <div class="col-md-8">
            <div class="book-panel">
                <h6 class="mb-3">Select Books to Borrow</h6>

                <div class="input-group mb-2">
                    <input id="bookSelectInput" type="text" class="form-control" placeholder="Enter Book Code" onkeyup="showSuggestions(this.value)">
                    <button class="btn btn-primary" onclick="searchBook()">Select</button>
                </div>
                <small id="searchBookErrorMessage" class="text-danger"></small>

                <h6 class="mt-4">Selected Books</h6>
                <table class="table table-hover align-middle" id="selectedBooksTable">
                    <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Book Title</th>
                        <th>Publisher</th>
                        <th>Due Date</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- Dynamic rows -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
</body>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    let selectedBooks = [];
    let selectedUser = null;

    function searchUser() {
        const q = $("#readerSelectInput").val().trim();
        if (!q) {
            $("#errorMessage").text("Please enter user ID, phone number or email.");
            $("#userInfo").empty();
            return;
        }

        const url = "/api/users/" + encodeURIComponent(q);
        $("#userInfo").empty();

        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                const statusClass = data.status === "ACTIVE" ? "text-success" : "text-danger";
                selectedUser = data;

                const card = `
                    <div class="card shadow-sm border-0">
                        <div class="card-body">
                            <div class="d-flex align-items-center mb-3">
                                <i class="bi bi-person-circle fs-3 text-primary me-2"></i>
                                <h6 class="card-title mb-0">${data.fullName ?? "Unknown User"}</h6>
                            </div>
                            <div class="ms-1">
                                <p class="mb-1"><i class="bi bi-envelope text-secondary me-1"></i>
                                    <strong>Email:</strong> ${data.email ?? "—"}</p>
                                <p class="mb-1"><i class="bi bi-telephone text-secondary me-1"></i>
                                    <strong>Phone:</strong> ${data.phoneNumber ?? "—"}</p>
                                <p class="mb-0"><i class="bi bi-person-badge text-secondary me-1"></i>
                                    <strong>Status:</strong> <span class="${statusClass}">${data.status ?? "Unknown"}</span></p>
                            </div>
                        </div>
                    </div>
                    `;
                $("#userInfo").html(card);
                $("#errorMessage").text("");
            },
            error: function (xhr, status, error) {
                // let message = "Have an error.";
                // try {
                //     const json = JSON.parse(xhr.responseText);
                //     if (json.message) message = json.message;
                // } catch (e) {
                //     message = xhr.responseText || "Can't connect to server.";
                // }

                $("#errorMessage").text("User not found.");
                $("#userInfo").empty();
                console.error("Ajax error:", status, error);
            }

        });
    }

    function searchBook() {
        const q = $("#bookSelectInput").val().trim();
        if (!q) {
            $("#searchBookErrorMessage").text("Please enter book code.");
            $("#bookResult").empty();
            return;
        }

        const url = "/api/v1/publications/" + encodeURIComponent(q);
        $("#bookResult").empty();

        $.ajax({
            url: url,
            type: "GET",
            success: function (data) {
                const exists = selectedBooks.some(book => book.barcode === data.barcode);
                if (exists) {
                    $("#searchBookErrorMessage").text("This book is already selected.");
                    return;
                }
                selectedBooks.push(data);
                console.log(selectedBooks);

                showSelectedBooks();
                $("#searchBookErrorMessage").text("");
            },
            error: function (xhr, status, error) {
                $("#searchBookErrorMessage").text("Book not found.");
            }
        })
    }

    function showSelectedBooks() {
        const today = new Date();
        today.setDate(today.getDate() + 14);
        const formattedDueDate = today.toISOString().split('T')[0]

        const rows = selectedBooks.map((book, index) => {
            return `
            <tr>
                <td>${index + 1}</td>
                <td>${book.title}</td>
                <td>${book.publisher}</td>
                <td>
                <input type="date" placeholder="Select due date" class="form-control-sm rounded-3 w-50 rounded-3 light-border" value="${formattedDueDate}">
                </td>
                <td><button class="btn btn-sm btn-danger" onclick="removeBook(${index})">Remove</button></td>
            </tr>`;
        }).join("");
        $("#selectedBooksTable tbody").html(rows);
    }


    function removeBook(index) {
        selectedBooks.splice(index, 1);
        showSelectedBooks();
    }

    function borrowBook() {
        if (!selectedUser) {
            alert("Please select a user before borrowing books.");
            return;
        }

        if (selectedBooks.length === 0) {
            alert("Please select at least one book.");
            return;
        }

        const books = selectedBooks.map((book, index) => {
            const returnDate = $("#selectedBooksTable tbody tr:nth-child(" + (index + 1) + ") input").val();
            return {
                publicationId: book.publicationId,
                returnDate: returnDate
            };
        });

        const borrowBook = {
            userId: selectedUser.id,
            books: books
        };

        $.ajax({
            url: "/api/v1/lending",
            type: "POST",
            data: JSON.stringify(borrowBook),
            contentType: "application/json",
            success: function (data) {
                alert("Borrowed successfully.");
                location.reload();
            },
            error: function (xhr, status, error) {
                alert("Can't borrow books.");
            }
        })

        console.log(borrowBook);
    }
</script>
