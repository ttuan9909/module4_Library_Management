<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Library - Return Books</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" th:href="@{/css/admin.css}">
    <link rel="stylesheet" th:href="@{/css/ad-lending.css}">
</head>
<body>
<div th:replace="admin/fragment/sidebar :: sidebar"></div>

<div class="main-content">
    <div class="page-header mb-4 d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Return Books</h5>
        <button class="btn btn-primary" onclick="returnBooks()">Return</button>
    </div>

    <div class="content-area row g-4">
        <div class="col-md-12">
            <div class="book-panel">
                <h6 class="mb-3">Select Books to Return</h6>
                <div class="input-group mb-2">
                    <input id="bookSelectInput" type="text" class="form-control" placeholder="Enter Book Code">
                    <button class="btn btn-primary" onclick="searchBook()">Select</button>
                </div>
                <small id="searchBookErrorMessage" class="text-danger"></small>

                <h6 class="mt-4">Selected Books</h6>
                <table class="table table-hover align-middle" id="selectedBooksTable">
                    <thead class="table-light">
                    <tr>
                        <th>#</th>
                        <th>Reader ID</th>
                        <th>Reader Name</th>
                        <th>Book Title</th>
                        <th>Borrow Date</th>
                        <th>Due Date</th>
                        <th>Fine</th>
                        <th>Status</th>
                        <th>Action</th>
                    </tr>
                    </thead>
                    <tbody></tbody>
                    <tfoot class="table-light">
                    <tr class="fw-bold align-middle border-top">
                        <td colspan="6" class="text-end pe-3">Total Fine:</td>
                        <td id="totalFine" class="text-end text-danger fs-5" colspan="3">0 ₫</td>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
    let selectedBooks = [];

    // Tìm sách theo mã
    function searchBook() {
        const code = $("#bookSelectInput").val().trim();
        if (!code) {
            $("#searchBookErrorMessage").text("Please enter book code.");
            return;
        }

        $.ajax({
            url: "/api/v1/lending/" + encodeURIComponent(code),
            type: "GET",
            success: function(data) {
                if (!data) {
                    $("#searchBookErrorMessage").text("Book not found.");
                    return;
                }
                if (selectedBooks.some(b => b.barcode === data.barcode)) {
                    $("#searchBookErrorMessage").text("This book is already selected.");
                    return;
                }
                selectedBooks.push(data);
                showSelectedBooks();
                $("#searchBookErrorMessage").text("");
            },
            error: function() {
                $("#searchBookErrorMessage").text("Error fetching book.");
            }
        });
    }

    // Hiển thị sách đã chọn
    function showSelectedBooks() {
        const today = new Date();
        const rows = selectedBooks.map((book, index) => {
            const dueDate = book.dueDate ? new Date(book.dueDate) : null;
            const diffDays = dueDate ? Math.floor((today - dueDate)/(1000*60*60*24)) : 0;
            const fine = diffDays > 0 ? diffDays*5000 : 0;

            book.fineAmount = fine;
            if (!book.status || book.status === "Borrowing") {
                book.status = "Returned";
            }

            // Chỉ hiển thị các trạng thái hợp lệ
            const statusOptions = ["Returned", "LostOrDamaged", "Overdue"]
                .map(s => `<option value="${s}" ${book.status === s ? 'selected' : ''}>${s}</option>`)
                .join("");

            return `
            <tr>
                <td>${index + 1}</td>
                <td>${book.userId}</td>
                <td>${book.fullName}</td>
                <td>${book.title}</td>
                <td>${book.borrowDate || '-'}</td>
                <td>${book.dueDate || '-'}</td>
                <td>
                    <input type="number" class="form-control form-control-sm text-end fine-input" value="${fine}" min="0" onchange="updateFine(${index}, this.value)">
                </td>
                <td>
                    <select class="form-select form-select-sm" onchange="updateStatus(${index}, this.value)">
                        ${statusOptions}
                    </select>
                </td>
                <td>
                    <button class="btn btn-sm btn-danger" onclick="removeBook(${index})">Remove</button>
                </td>
            </tr>
        `;
        }).join("");

        $("#selectedBooksTable tbody").html(rows);
        updateTotalFine();
    }

    function removeBook(index) {
        selectedBooks.splice(index, 1);
        showSelectedBooks();
    }

    function updateFine(index, newFine) {
        selectedBooks[index].fineAmount = parseFloat(newFine) || 0;
        updateTotalFine();
    }

    function updateStatus(index, newStatus) {
        selectedBooks[index].status = newStatus;
    }

    function updateTotalFine() {
        const total = selectedBooks.reduce((sum, book) => sum + (book.fineAmount || 0), 0);
        $("#totalFine").text(total.toLocaleString("vi-VN") + " ₫");
    }

    // Gửi trả sách cho nhiều user
    function returnBooks() {
        if (selectedBooks.length === 0) {
            alert("Please select at least one book.");
            return;
        }

        const usersMap = {};
        selectedBooks.forEach(book => {
            if (!usersMap[book.userId]) usersMap[book.userId] = { userId: book.userId, books: [] };
            usersMap[book.userId].books.push({
                publicationId: book.publicationId,
                returnDate: new Date().toISOString().split('T')[0],
                fineAmount: book.fineAmount,
                status: book.status
            });
        });

        const payload = { users: Object.values(usersMap) };

        $.ajax({
            url: "/api/v1/return",
            type: "POST",
            data: JSON.stringify(payload),
            contentType: "application/json",
            success: function() {
                alert("Books returned successfully!");
                location.reload();
            },
            error: function() {
                alert("Error returning books.");
            }
        });

        console.log(payload);
    }
</script>
</body>
</html>
