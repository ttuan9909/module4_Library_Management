<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách sách</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <style>
        body { background-color: #f6f7fb; font-family: "Segoe UI", sans-serif; }
        .sidebar { width: 250px; height: 100vh; background-color: #f8f9fa; border-right: 1px solid #e5e5e5;
                   position: fixed; top: 0; left: 0; padding: 0 20px 20px 20px; }
        .sidebar-brand { padding: 20px 0; margin-bottom: 10px; border-bottom: 1px solid #e5e5e5; text-align: left; }
        .sidebar-brand h4 { margin: 0; font-weight: 700; color: #1c7c54; }
        .sidebar a { display: flex; align-items: center; padding: 10px 15px; border-radius: 6px; color: #333;
                     text-decoration: none; margin-bottom: 6px; }
        .sidebar a.active { background-color: #e0f3eb; color: #1c7c54; font-weight: 600; }
        .sidebar a:hover { background-color: #f0f0f0; transition: background-color 0.2s; }
        .sidebar i { width: 25px; }
        .main-content { margin-left: 250px; padding: 20px; }
        .page-header { background-color: #fff; padding: 12px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                       display: flex; justify-content: space-between; align-items: center; }
        .client-table { background: #fff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); padding: 20px; margin-top: 20px; }
        .table td { padding: 12px; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; color: #fff; font-weight: 600;
                        display: inline-block; min-width: 80px; text-align: center; }
        .status-Available { background-color: #1c7c54; }
        .status-Discontinued { background-color: #6c757d; }
        .quantity-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; background-color: #0d6efd; color: #fff; }
        @keyframes pulse-green { 0% { background-color: #e0f3eb; } 100% { background-color: transparent; } }
        .new-row-pulse { animation: pulse-green 3s ease-out forwards; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-brand">
        <a th:href="@{/admin}" class="text-decoration-none text-dark d-inline-block">
            <h4><i class="fas fa-book-open me-2"></i>LIBRARY LOGO</h4>
        </a>
    </div>
    <a th:href="@{/admin}"><i class="fas fa-hand-holding-usd"></i> Book Lending</a>
    <a th:href="@{/return}"><i class="fas fa-undo-alt"></i> Book Return</a>
    <a th:href="@{/admin/books}" class="active"><i class="fas fa-book"></i> Book List</a>
    <a th:href="@{/publications}"><i class="fas fa-newspaper"></i> Publications</a>
    <a th:href="@{/categories}"><i class="fas fa-tags"></i> Book Categories</a>
    <a th:href="@{/users}"><i class="fas fa-users"></i> Members</a>
</div>

<div class="main-content">
    <div class="page-header">
        <h4 class="m-0">
            <i class="fas fa-book me-2 text-primary"></i> Danh sách sách
        </h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBookModal">
            <i class="fas fa-plus-circle me-1"></i> Thêm sách mới
        </button>
    </div>

    <div class="client-table p-3 mb-3">
        <div class="row align-items-center">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tiêu đề, tác giả, ISBN...">
                </div>
            </div>
            <div class="col-md-7 text-end">
                <label class="form-label me-2 mb-0 fw-bold text-muted">Lọc theo:</label>
                <select id="categoryFilter" class="form-select d-inline-block w-auto me-2">
                    <option value="">Tất cả thể loại</option>
                </select>
                <select id="statusFilter" class="form-select d-inline-block w-auto">
                    <option value="">Tất cả trạng thái</option>
                    <option value="Available">Còn hàng</option>
                    <option value="Discontinued">Ngừng cung cấp</option>
                </select>
            </div>
        </div>
    </div>

    <div class="client-table">
        <table id="bookTable" class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
                <th class="text-center" style="width: 5%">#</th>
                <th style="width: 25%">Tiêu đề</th>
                <th style="width: 15%">Thể loại</th>
                <th style="width: 15%">Nhà XB</th>
                <th class="text-center" style="width: 10%">Năm XB</th>
                <th class="text-center" style="width: 10%">Số lượng</th>
                <th class="text-center" style="width: 10%">Trạng thái</th>
                <th class="text-center" style="width: 15%">Thao tác</th>
            </tr>
            </thead>
            <tbody id="bookTableBody">
            </tbody>
        </table>

        <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">Hiển thị 1 - 10 trong tổng số <span id="totalBooks">0</span> sách</small>
            <nav>
                <ul class="pagination pagination-sm m-0">
                    <li class="page-item disabled"><a class="page-link" href="#">Trước</a></li>
                    <li class="page-item active"><a class="page-link" href="#">1</a></li>
                    <li class="page-item"><a class="page-link" href="#">2</a></li>
                    <li class="page-item"><a class="page-link" href="#">Sau</a></li>
                </ul>
            </nav>
        </div>
    </div>

    <footer class="text-center text-muted mt-4">© 2025 Library Management System</footer>
</div>

<!-- MODAL THÊM/SỬA SÁCH -->
<div class="modal fade" id="addBookModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="bookForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title" id="modalTitle">Thêm sách mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bookId">
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label class="form-label">Tiêu đề <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="title" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Nhà xuất bản</label>
                            <input type="text" class="form-control" id="publisher">
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-3">
                            <label class="form-label">Năm XB</label>
                            <input type="number" class="form-control" id="publishYear" min="1000" max="2100">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Ngôn ngữ</label>
                            <input type="text" class="form-control" id="language">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Thể loại <span class="text-danger">*</span></label>
                            <select class="form-select" id="categoryId" required>
                                <option value="">Chọn thể loại</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-3">
                        <div class="col-md-9">
                            <label class="form-label">Mô tả</label>
                            <textarea class="form-control" id="description" rows="3"></textarea>
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Trạng thái</label>
                            <select class="form-select" id="status">
                                <option value="Available">Còn hàng</option>
                                <option value="Discontinued">Ngừng cung cấp</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Lưu</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    const API_URL = '/api/booklist';

    function getValueOrNull(id) {
        const val = $(`#${id}`).val();
        return val === '' ? null : val;
    }

    function loadBooks() {
        $.get(API_URL).done(books => {
            const tbody = $('#bookTableBody');
            tbody.empty();
            $('#totalBooks').text(books.length);
            books.forEach((book, index) => {
                const statusClass = book.status === 'Available' ? 'status-Available' : 'status-Discontinued';
                const row = `
                    <tr class="new-row-pulse" data-book-id="${book.bookId}">
                        <td class="text-center">${index + 1}</td>
                        <td><a href="/admin/books/${book.bookId}/detail" class="text-decoration-none fw-bold">${escapeHtml(book.title)}</a></td>
                        <td>${escapeHtml(book.category?.categoryName || 'N/A')}</td>
                        <td>${escapeHtml(book.publisher || 'N/A')}</td>
                        <td class="text-center">${book.publishYear || 'N/A'}</td>
                        <td class="text-center"><span class="quantity-badge">${book.quantity}</span></td>
                        <td class="text-center"><span class="status-badge ${statusClass}">${book.status}</span></td>
                        <td class="text-center">
                            <a href="/admin/books/${book.bookId}/detail" class="btn btn-sm btn-outline-info me-1" title="Chi tiết"><i class="fas fa-eye"></i></a>
                            <button class="btn-edit btn btn-sm btn-outline-primary me-1" data-book-id="${book.bookId}" title="Sửa"><i class="fas fa-edit"></i></button>
                            <button class="btn-delete btn btn-sm btn-outline-danger" data-book-id="${book.bookId}" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
                tbody.append(row);
            });
            if (books.length === 0) tbody.append('<tr id="emptyRow"><td colspan="8" class="text-center text-muted">Không có sách nào</td></tr>');
        });
    }

    function loadCategories() {
        $.get(API_URL + '/categories').done(cats => {
            const select = $('#categoryId, #editCategoryId');
            select.empty().append('<option value="">Chọn thể loại</option>');
            cats.forEach(cat => select.append(`<option value="${cat.categoryId}">${escapeHtml(cat.categoryName)}</option>`));
        });
    }

    $('#searchInput, #categoryFilter, #statusFilter').on('input change', function() {
        const search = $('#searchInput').val().toLowerCase();
        const cat = $('#categoryFilter').val();
        const status = $('#statusFilter').val();
        let visible = 0;
        $('#bookTableBody tr').each(function() {
            const $row = $(this);
            const title = $row.find('td:eq(1)').text().toLowerCase();
            const category = $row.find('td:eq(2)').text();
            const bookStatus = $row.find('.status-badge').text();
            const matches = title.includes(search) && (!cat || category === cat) && (!status || bookStatus === status);
            $row.toggle(matches);
            if (matches) visible++;
        });
        $('#emptyRow').toggle(visible === 0);
    });

    $('#bookForm').submit(function(e) {
        e.preventDefault();
        const id = $('#bookId').val();
        const data = {
            title: $('#title').val().trim(),
            publisher: getValueOrNull('publisher'),
            publishYear: getValueOrNull('publishYear') ? parseInt($('#publishYear').val()) : null,
            language: getValueOrNull('language'),
            description: getValueOrNull('description'),
            category: { categoryId: parseInt($('#categoryId').val()) },
            status: $('#status').val()
        };
        const method = id ? 'PUT' : 'POST';
        const url = id ? `${API_URL}/${id}` : API_URL;

        $.ajax({ url, method, contentType: 'application/json', data: JSON.stringify(data),
            success: () => { $('#addBookModal').modal('hide'); loadBooks(); },
            error: xhr => alert(xhr.responseJSON?.error || 'Lỗi hệ thống!')
        });
    });

    $(document).on('click', '.btn-edit', function() {
        const id = $(this).data('book-id');
        $.get(`${API_URL}/${id}`).done(book => {
            $('#bookId').val(book.bookId);
            $('#modalTitle').text('Sửa sách');
            $('#title').val(book.title);
            $('#publisher').val(book.publisher);
            $('#publishYear').val(book.publishYear);
            $('#language').val(book.language);
            $('#description').val(book.description);
            $('#categoryId').val(book.category.categoryId);
            $('#status').val(book.status);
            $('#addBookModal').modal('show');
        });
    });

    $(document).on('click', '.btn-delete', function() {
        const id = $(this).data('book-id');
        if (confirm('Xóa sách này?')) {
            $.ajax({ url: `${API_URL}/${id}`, method: 'DELETE',
                success: () => loadBooks(),
                error: () => alert('Xóa thất bại!')
            });
        }
    });

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    $(document).ready(() => {
        loadBooks();
        loadCategories();
    });
</script>
</body>
</html>