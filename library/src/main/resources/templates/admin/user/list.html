<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Danh sách thành viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>

    <!-- CSRF TOKEN -->
    <meta name="_csrf" th:content="${_csrf.token}"/>
    <meta name="_csrf_header" th:content="${_csrf.headerName}"/>

    <style>
        body { background-color: #f6f7fb; font-family: "Segoe UI", sans-serif; }
        .sidebar { width: 250px; height: 100vh; background-color: #f8f9fa; border-right: 1px solid #e5e5e5;
                   position: fixed; top: 0; left: 0; padding: 0 20px 20px 20px; }
        .sidebar-brand { padding: 20px 0; margin-bottom: 10px; border-bottom: 1px solid #e5e5e5; text-align: left; }
        .sidebar-brand h4 { margin: 0; font-weight: 700; color: #1c7c54; }
        .sidebar a { display: flex; align-items: center; padding: 10px 15px; border-radius: 6px; color: #333;
                     text-decoration: none; margin-bottom: 6px; }
        .sidebar a.active { background-color: #e0f3eb; color: #1c7c54; font-weight: 600; }
        .sidebar a:hover { background-color: #f0f0f0; transition: background-color 0.2s; }
        .sidebar i { width: 25px; }
        .main-content { margin-left: 250px; padding: 20px; }
        .page-header { background-color: #fff; padding: 12px 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                       display: flex; justify-content: space-between; align-items: center; }
        .client-table { background: #fff; border-radius: 10px; box-shadow: 0 2px 6px rgba(0,0,0,0.05); padding: 20px; margin-top: 20px; }
        .status-badge { padding: 5px 10px; border-radius: 12px; font-size: 12px; color: #fff; font-weight: 600;
                        display: inline-block; min-width: 80px; text-align: center; }
        .status-ACTIVE { background-color: #1c7c54; }
        .status-LOCKED { background-color: #dc3545; }
        .status-DISABLED { background-color: #6c757d; }
        .role-badge { padding: 4px 8px; border-radius: 4px; font-size: 12px; font-weight: 500; }
        .role-ROLE_ADMIN { background-color: #0d6efd; color: #fff; }
        .role-ROLE_READER { background-color: #f8f9fa; color: #333; border: 1px solid #ddd; }
        @keyframes pulse-green { 0% { background-color: #e0f3eb; } 100% { background-color: transparent; } }
        .new-row-pulse { animation: pulse-green 2s ease-out forwards; }
        .toast-container { position: fixed; top: 20px; right: 20px; z-index: 9999; }
    </style>
</head>
<body>
<div class="sidebar">
    <div class="sidebar-brand">
        <a th:href="@{/admin}" class="text-decoration-none text-dark d-inline-block">
            <h4><i class="fas fa-book-open me-2"></i>LIBRARY LOGO</h4>
        </a>
    </div>
    <a th:href="@{/admin}"><i class="fas fa-hand-holding-usd"></i> Book Lending</a>
    <a th:href="@{/return}"><i class="fas fa-undo-alt"></i> Book Return</a>
    <a th:href="@{/admin/books}"><i class="fas fa-book"></i> Book List</a>
    <a th:href="@{/publications}"><i class="fas fa-newspaper"></i> Publications</a>
    <a th:href="@{/categories}"><i class="fas fa-tags"></i> Book Categories</a>
    <a th:href="@{/admin/users}" class="active"><i class="fas fa-users"></i> Members</a>
</div>

<div class="main-content">
    <div class="page-header">
        <h4 class="m-0">
            <i class="fas fa-users me-2 text-primary"></i> Danh sách thành viên
        </h4>
        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal" onclick="resetAddForm()">
            <i class="fas fa-plus-circle me-1"></i> Thêm thành viên
        </button>
    </div>

    <!-- Tìm kiếm & Lọc -->
    <div class="client-table p-3 mb-3">
        <div class="row align-items-center">
            <div class="col-md-5">
                <div class="input-group">
                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                    <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm theo tên, email, SĐT...">
                </div>
            </div>
            <div class="col-md-7 text-end">
                <label class="form-label me-2 mb-0 fw-bold text-muted">Lọc:</label>
                <select id="roleFilter" class="form-select d-inline-block w-auto me-2">
                    <option value="">Tất cả Vai trò</option>
                    <option value="ROLE_ADMIN">ROLE_ADMIN</option>
                    <option value="ROLE_READER">ROLE_READER</option>
                </select>
                <select id="statusFilter" class="form-select d-inline-block w-auto">
                    <option value="">Tất cả Trạng thái</option>
                    <option value="ACTIVE">Hoạt động</option>
                    <option value="LOCKED">Bị khoá</option>
                    <option value="DISABLED">Không hoạt động</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Bảng thành viên -->
    <div class="client-table">
        <table id="userTable" class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th class="text-center" style="width: 5%">#</th>
                    <th style="width: 20%">Họ tên</th>
                    <th style="width: 20%">Email</th>
                    <th class="text-center" style="width: 10%">SĐT</th>
                    <th class="text-center" style="width: 10%">Tài khoản</th>
                    <th class="text-center" style="width: 10%">Vai trò</th>
                    <th class="text-center" style="width: 10%">Trạng thái</th>
                    <th class="text-center" style="width: 15%">Thao tác</th>
                </tr>
            </thead>
            <tbody id="userTableBody">
                <tr><td colspan="8" class="text-center py-5 text-muted">Đang tải dữ liệu...</td></tr>
            </tbody>
        </table>
        <div class="d-flex justify-content-between align-items-center mt-3">
            <small class="text-muted">Hiển thị <span id="showing">0</span> trong tổng <span id="totalUsers">0</span> thành viên</small>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Modal Thêm thành viên -->
<div class="modal fade" id="addUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <form id="addUserForm">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">Thêm thành viên mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6 border-end pe-4">
                            <h6 class="text-primary mb-3">Thông tin tài khoản</h6>
                            <div class="mb-3"><label class="form-label">Họ tên <span class="text-danger">*</span></label><input type="text" id="fullName" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label">Email <span class="text-danger">*</span></label><input type="email" id="email" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label">Số điện thoại <span class="text-danger">*</span></label><input type="text" id="phoneNumber" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label">Tên đăng nhập <span class="text-danger">*</span></label><input type="text" id="username" class="form-control" required></div>
                            <div class="mb-3"><label class="form-label">Mật khẩu <span class="text-danger">*</span></label><input type="password" id="password" class="form-control" required></div>
                        </div>
                        <div class="col-md-6 ps-4">
                            <h6 class="text-success mb-3">Thông tin thẻ thư viện</h6>
                            <p class="alert alert-info py-2 px-3 mb-3"><small>Ngày Kết thúc có thể bỏ trống, hệ thống sẽ tự động gán 1 năm.</small></p>
                            <div class="mb-3"><label class="form-label">Ngày bắt đầu</label><input type="date" id="cardStartDate" class="form-control"></div>
                            <div class="mb-3"><label class="form-label">Ngày kết thúc (Tùy chọn)</label><input type="date" id="cardEndDate" class="form-control"></div>
                            <div class="mb-3"><label class="form-label">Trạng thái thẻ</label>
                                <select id="cardStatus" class="form-select">
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="EXPIRED">EXPIRED</option>
                                    <option value="SUSPENDED">SUSPENDED</option>
                                </select>
                            </div>
                            <div class="mb-3"><label class="form-label">Ghi chú</label><textarea id="cardNotes" class="form-control" rows="2"></textarea></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary">Thêm thành viên</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Sửa thành viên -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <form id="editUserForm">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title">Chỉnh sửa thành viên</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editUserId">
                    <input type="hidden" id="editUsername">
                    <div class="row">
                        <div class="col-md-6 border-end pe-4">
                            <h6 class="text-primary mb-3">Thông tin tài khoản</h6>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Họ tên</label><input type="text" id="editFullName" class="form-control"></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Email</label><input type="email" id="editEmail" class="form-control"></div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3"><label class="form-label">Số điện thoại</label><input type="text" id="editPhoneNumber" class="form-control"></div>
                                <div class="col-md-6 mb-3"><label class="form-label">Ngày sinh</label><input type="date" id="editDateOfBirth" class="form-control"></div>
                            </div>
                            <div class="mb-3"><label class="form-label">Địa chỉ</label><textarea id="editAddress" class="form-control" rows="2"></textarea></div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Vai trò</label>
                                    <select id="editRoleName" class="form-select">
                                        <option value="ROLE_READER">ROLE_READER</option>
                                        <option value="ROLE_ADMIN">ROLE_ADMIN</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Trạng thái</label>
                                    <select id="editStatus" class="form-select">
                                        <option value="ACTIVE">ACTIVE</option>
                                        <option value="LOCKED">LOCKED</option>
                                        <option value="DISABLED">DISABLED</option>
                                    </select>
                                </div>
                            </div>
                            <div class="mb-3"><label class="form-label">Avatar URL</label><input type="url" id="editAvatarUrl" class="form-control"></div>
                            <p class="text-muted"><small>Để trống mật khẩu để giữ nguyên.</small></p>
                            <div class="mb-3"><label class="form-label">Mật khẩu mới (Tùy chọn)</label><input type="password" id="editPassword" class="form-control"></div>
                        </div>
                        <div class="col-md-6 ps-4">
                            <h6 class="text-success mb-3">Thông tin thẻ thư viện</h6>
                            <p class="alert alert-info py-2 px-3 mb-3"><small>Ngày Kết thúc có thể bỏ trống.</small></p>
                            <div class="mb-3"><label class="form-label">Số thẻ</label><input type="text" id="editCardNumber" class="form-control" readonly></div>
                            <div class="mb-3"><label class="form-label">Ngày bắt đầu</label><input type="date" id="editCardStartDate" class="form-control"></div>
                            <div class="mb-3"><label class="form-label">Ngày kết thúc</label><input type="date" id="editCardEndDate" class="form-control"></div>
                            <div class="mb-3">
                                <label class="form-label">Trạng thái thẻ</label>
                                <select id="editCardStatus" class="form-select">
                                    <option value="ACTIVE">ACTIVE</option>
                                    <option value="EXPIRED">EXPIRED</option>
                                    <option value="SUSPENDED">SUSPENDED</option>
                                </select>
                            </div>
                            <div class="mb-3"><label class="form-label">Ghi chú</label><textarea id="editCardNotes" class="form-control" rows="3"></textarea></div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-success">Lưu thay đổi</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Xác nhận Xóa -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Xác nhận xóa</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <p>Bạn có chắc chắn muốn <strong>xóa thành viên này</strong>?</p>
                <p class="text-muted small">Hành động này <strong>không thể hoàn tác</strong>.</p>
            </div>
            <div class="modal-footer justify-content-center">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa ngay</button>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
    /*<![CDATA[*/
    const API_BASE = '/admin/users';
    const csrfToken = /*[[${_csrf.token}]]*/ '';
    const csrfHeader = /*[[${_csrf.headerName}]]*/ '';
    let deleteUserId = null;

    $(document).ajaxSend(function(e, xhr, options) {
        if (['POST', 'PUT', 'DELETE'].includes(options.type)) {
            xhr.setRequestHeader(csrfHeader, csrfToken);
        }
    });

    function showToast(message, type = 'success') {
        const bg = type === 'success' ? 'bg-success' : 'bg-danger';
        const icon = type === 'success' ? 'check-circle' : 'exclamation-triangle';
        const toast = `
            <div class="toast align-items-center text-white ${bg} border-0" role="alert">
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${icon} me-2"></i> ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>`;
        $('#toastContainer').append(toast);
        const newToast = $('#toastContainer .toast').last()[0];
        const bsToast = new bootstrap.Toast(newToast, { delay: 3000 });
        bsToast.show();
        $(newToast).on('hidden.bs.toast', () => $(newToast).remove());
    }

    function resetAddForm() {
        $('#addUserForm')[0].reset();
    }

    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function loadUsers() {
    $.get(API_BASE)
        .done(response => {

            // Lấy danh sách user đúng trường dữ liệu
            const users = response.content || response.data || response;

            const tbody = $('#userTableBody');
            tbody.empty();

            $('#totalUsers').text(response.totalElements || users.length);
            $('#showing').text(users.length);

            if (!Array.isArray(users) || users.length === 0) {
                tbody.append('<tr><td colspan="8" class="text-center text-muted py-5">Không có thành viên nào</td></tr>');
                return;
            }

            users.forEach((user, index) => {
                const roleClass = user.roleName === 'ROLE_ADMIN' ? 'ROLE_ADMIN' : 'ROLE_READER';
                const statusClass = user.status === 'ACTIVE' ? 'ACTIVE' :
                                    user.status === 'LOCKED' ? 'LOCKED' : 'DISABLED';

                const row = `
                    <tr class="new-row-pulse" data-user-id="${user.userId}">
                        <td class="text-center">${index + 1}</td>
                        <td><a href="/admin/users/detail/${user.userId}" class="text-decoration-none fw-bold">${escapeHtml(user.fullName || 'N/A')}</a></td>
                        <td>${escapeHtml(user.email || 'N/A')}</td>
                        <td class="text-center">${escapeHtml(user.phoneNumber || 'N/A')}</td>
                        <td class="text-center">${escapeHtml(user.username)}</td>
                        <td class="text-center"><span class="role-badge role-${roleClass}">${user.roleName}</span></td>
                        <td class="text-center"><span class="status-badge status-${statusClass}">${user.status}</span></td>
                        <td class="text-center">
                            <a href="/admin/users/detail/${user.userId}" class="btn btn-sm btn-outline-info me-1" title="Chi tiết"><i class="fas fa-eye"></i></a>
                            <button class="btn btn-sm btn-outline-primary me-1 btn-edit" data-id="${user.userId}" title="Sửa"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${user.userId}" title="Xóa"><i class="fas fa-trash-alt"></i></button>
                        </td>
                    </tr>`;
                tbody.append(row);
            });
        })
        .fail(xhr => {
            console.error('Lỗi load users:', xhr);
            if (xhr.status === 401 || xhr.status === 403) {
                showToast('Phiên đăng nhập hết hạn! Đang chuyển về login...', 'danger');
                setTimeout(() => location.href = '/login', 2000);
            } else {
                showToast('Không tải được danh sách! (Lỗi: ' + xhr.status + ')', 'danger');
            }
        });
    }


    // Lọc + Tìm kiếm
    $('#searchInput, #roleFilter, #statusFilter').on('input change', function() {
        const search = $('#searchInput').val().toLowerCase();
        const role = $('#roleFilter').val();
        const status = $('#statusFilter').val();
        let visible = 0;
        $('#userTableBody tr').each(function() {
            const $row = $(this);
            const name = $row.find('td:eq(1)').text().toLowerCase();
            const email = $row.find('td:eq(2)').text().toLowerCase();
            const phone = $row.find('td:eq(3)').text().toLowerCase();
            const rowRole = $row.find('.role-badge').text();
            const rowStatus = $row.find('.status-badge').text();
            const match = name.includes(search) || email.includes(search) || phone.includes(search);
            const matchRole = !role || rowRole === role;
            const matchStatus = !status || rowStatus === status;
            $row.toggle(match && matchRole && matchStatus);
            if (match && matchRole && matchStatus) visible++;
        });
        $('#showing').text(visible);
    });

    // Thêm thành viên
    $('#addUserForm').submit(function(e) {
        e.preventDefault();
        const data = {
            fullName: $('#fullName').val().trim(),
            email: $('#email').val().trim(),
            phoneNumber: $('#phoneNumber').val().trim(),
            username: $('#username').val().trim(),
            password: $('#password').val(),
            libraryCard: {
                startDate: $('#cardStartDate').val() || null,
                endDate: $('#cardEndDate').val() || null,
                status: $('#cardStatus').val(),
                notes: $('#cardNotes').val().trim() || null
            }
        };

        $.ajax({
            url: API_BASE + '/create',
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: () => {
                $('#addUserModal').modal('hide');
                resetAddForm();
                loadUsers();
                showToast('Thêm thành viên thành công!', 'success');
            },
            error: xhr => showToast(xhr.responseJSON?.message || 'Thêm thất bại!', 'danger')
        });
    });

    // Sửa thành viên
    $(document).on('click', '.btn-edit', function() {
        const id = $(this).data('id');
        $.get(API_BASE + '/' + id).done(user => {
            $('#editUserId').val(user.userId);
            $('#editUsername').val(user.username);
            $('#editFullName').val(user.fullName || '');
            $('#editEmail').val(user.email || '');
            $('#editPhoneNumber').val(user.phoneNumber || '');
            $('#editAddress').val(user.address || '');
            $('#editAvatarUrl').val(user.avatarUrl || '');
            $('#editDateOfBirth').val(user.dateOfBirth ? user.dateOfBirth.split('T')[0] : '');
            $('#editRoleName').val(user.roleName || 'ROLE_READER');
            $('#editStatus').val(user.status || 'ACTIVE');
            $('#editPassword').val('');

            if (user.libraryCard) {
                $('#editCardNumber').val(user.libraryCard.cardNumber || '');
                $('#editCardStartDate').val(user.libraryCard.startDate ? user.libraryCard.startDate.split('T')[0] : '');
                $('#editCardEndDate').val(user.libraryCard.endDate ? user.libraryCard.endDate.split('T')[0] : '');
                $('#editCardStatus').val(user.libraryCard.status || 'ACTIVE');
                $('#editCardNotes').val(user.libraryCard.notes || '');
            } else {
                $('#editCardNumber').val('CHƯA CÓ THẺ');
                $('#editCardStartDate').val('');
                $('#editCardEndDate').val('');
                $('#editCardStatus').val('ACTIVE');
                $('#editCardNotes').val('');
            }

            $('#editUserModal').modal('show');
        }).fail(() => showToast('Không tải được dữ liệu!', 'danger'));
    });

    $('#editUserForm').submit(function(e) {
        e.preventDefault();
        const id = $('#editUserId').val();
        const data = {
            username: $('#editUsername').val(),
            fullName: $('#editFullName').val(),
            email: $('#editEmail').val(),
            phoneNumber: $('#editPhoneNumber').val(),
            address: $('#editAddress').val(),
            avatarUrl: $('#editAvatarUrl').val(),
            dateOfBirth: $('#editDateOfBirth').val() || null,
            roleName: $('#editRoleName').val(),
            status: $('#editStatus').val(),
            password: $('#editPassword').val() || undefined,
            libraryCard: {
                cardNumber: $('#editCardNumber').val(),
                startDate: $('#editCardStartDate').val() || null,
                endDate: $('#editCardEndDate').val() || null,
                status: $('#editCardStatus').val(),
                notes: $('#editCardNotes').val() || null
            }
        };

        $.ajax({
            url: API_BASE + '/update/' + id,
            method: 'PUT',
            contentType: 'application/json',
            data: JSON.stringify(data),
            success: () => {
                $('#editUserModal').modal('hide');
                loadUsers();
                showToast('Cập nhật thành công!', 'success');
            },
            error: xhr => showToast(xhr.responseJSON?.message || 'Cập nhật thất bại!', 'danger')
        });
    });

    // Xóa
    $(document).on('click', '.btn-delete', function() {
        deleteUserId = $(this).data('id');
        $('#confirmDeleteModal').modal('show');
    });

    $('#confirmDeleteBtn').click(function() {
        if (!deleteUserId) return;
        $.ajax({
            url: API_BASE + '/' + deleteUserId,
            method: 'DELETE',
            success: () => {
                $('#confirmDeleteModal').modal('hide');
                loadUsers();
                showToast('Xóa thành viên thành công!', 'success');
            },
            error: () => showToast('Xóa thất bại!', 'danger')
        });
        deleteUserId = null;
    });

    $(document).ready(() => {
        loadUsers();
    });
    /*]]>*/
</script>
</body>
</html>